# 2026-01-12 작업 완료 내역

## ⚠️ 최우선 작업 (미완료)

### GitHub Actions 워크플로우 푸시 실패

**상황:**
- `.github/workflows/cron-jobs.yml` 파일 생성 완료
- 커밋 완료 (`a991678`)
- **푸시 실패**: GitHub 리포지토리 규칙이 워크플로우 파일 푸시 차단

**에러 메시지:**
```
remote: error: GH013: Repository rule violations found for refs/heads/main.
remote: - refusing to allow an OAuth App to create or update workflow `.github/workflows/cron-jobs.yml` without `workflow` scope
```

**해결 방법 (선택):**

#### Option 1: GitHub 리포지토리 규칙 수정 (추천)
1. https://github.com/sinn357/manage-agent-app/settings/rules 접속
2. "Restrict creation and updates to certain workflows" 규칙 찾기
3. 규칙 비활성화 또는 예외 추가
4. 다시 푸시: `git push`

#### Option 2: GitHub Web UI에서 직접 추가
1. https://github.com/sinn357/manage-agent-app 접속
2. "Add file" → "Create new file"
3. 파일명: `.github/workflows/cron-jobs.yml`
4. 내용: 로컬 파일 복사 (`/Users/woocheolshin/Documents/Vibecoding/projects/manage-agent-app/.github/workflows/cron-jobs.yml`)

#### Option 3: OAuth 앱 권한 재설정
1. GitHub Settings → Developer settings → OAuth Apps
2. Claude Code 앱 찾기
3. `workflow` scope 추가

**다음 단계:**
1. 위 방법 중 하나로 워크플로우 파일 푸시
2. GitHub Secrets에 `CRON_SECRET` 추가
   - Settings → Secrets and variables → Actions → New repository secret
   - Name: `CRON_SECRET`
   - Value: Vercel 환경변수 `CRON_SECRET`와 동일한 값
3. 워크플로우 수동 실행으로 테스트
   - Actions 탭 → "Manage Agent Cron Jobs" → "Run workflow"

---

## ✅ 완료된 작업

### 1. Task Weight 필드 추가 (목표 진행률 개선)

**문제:**
```
목표: 나무 100개 베기
작업 1: 나무 10개 베기 ✓ → 진행률 100% (1/1)
작업 2: 나무 20개 베기 (다음날 추가 예정) → 이미 100%...
```
- 작업 개수 기반 진행률 계산의 한계
- 작은 단계로 큰 목표 달성 시 진행률이 부정확

**해결:**
- Task 모델에 `weight` 필드 추가 (기본값 1, 범위 1-100)
- 목표 진행률을 weight 기반으로 계산
- 작업 생성/수정 UI에 "목표 기여도" 입력 추가

**사용 예시:**
```
목표: 나무 100개 베기 (targetWeight: 100)
├─ 작업 1: 나무 10개 베기 (weight: 10) ✓ → 10% (10/100)
├─ 작업 2: 나무 20개 베기 (weight: 20) → 다음날 추가
└─ 작업 3: 나무 70개 베기 (weight: 70) → 모레 추가

진행률 = completedWeight / totalWeight = 10 / 100 = 10%
```

**수정 파일:**
- `prisma/schema.prisma:78` - Task.weight 필드 추가
- `app/api/goals/route.ts:38-96` - weight 기반 진행률 계산
- `components/dashboard/TaskModal.tsx:34-52, 80-90, 136-147, 162-183, 408-454` - weight 입력 UI

**DB 마이그레이션 필요:**
```bash
npm run db:push
# 또는 Vercel 배포 시 자동 실행 (vercel-build: "prisma db push && next build")
```

---

### 2. GitHub Actions 크론잡 설정

**문제:**
- Vercel Hobby 플랜은 하루 1회 크론만 허용
- 루틴 결과 집계 (자정)와 12시간 아카이브가 실행 불가

**해결:**
- GitHub Actions 워크플로우 생성
- 매일 자정 KST (UTC 15:00) 실행
- 두 가지 크론 작업:
  1. 루틴 결과 집계 (`/api/cron/routine-results`)
  2. 12시간 지난 작업 아카이브 (`/api/cron/archive-tasks`)

**신규 파일:**
- `.github/workflows/cron-jobs.yml` (생성 완료, 푸시 대기 중)

**워크플로우 내용:**
```yaml
on:
  schedule:
    - cron: '0 15 * * *'  # 매일 자정 KST
  workflow_dispatch:      # 수동 실행 허용

jobs:
  routine-results:
    # 루틴 결과 집계

  archive-tasks:
    # 12시간 지난 작업 아카이브
```

**설정 필요:**
- GitHub Secrets: `CRON_SECRET` (Vercel 환경변수와 동일)

---

### 3. 모바일 UI 개선

**문제:**
- 모바일에서 로그아웃 버튼이 화면 밖으로 삐져나감
- 가로 스크롤 발생

**해결:**
- 헤더 버튼 간격 축소: `gap-0.5` (모바일), `gap-2` (데스크톱)
- 버튼 padding 축소: `px-2` (모바일), `px-3` (데스크톱)
- 로고 크기 축소: `w-8` (모바일), `w-10` (데스크톱)
- `flex-shrink-0`으로 넘침 방지

**수정 파일:**
- `app/dashboard/page.tsx:270-341` - 반응형 헤더

**커밋:** `bf74068`

---

### 4. 하이브리드 알림 시스템

**문제:**
- Mac Chrome: 시스템 알림 설정이 복잡함
- iOS Safari: Web Notifications API 미지원
- 알림 소리 없음

**해결:**
- **탭 활성**: Web Audio API 벨 소리 + Sonner 토스트
- **탭 비활성**: 시스템 알림 (지원 시)
- **iOS Safari**: 자동 감지 후 토스트로 대체

**신규 파일:**
- `lib/notificationSound.ts` - Web Audio API 벨 소리

**수정 파일:**
- `lib/notifications.ts` - 하이브리드 로직
- `app/layout.tsx` - Sonner Toaster 추가
- `app/settings/page.tsx` - 테스트 알림 업데이트
- `app/globals.css:296-321` - Sonner 스타일

**커밋:** `aad7719`, `bf74068`, `0e1aff3`

---

### 5. 포커스 타이머 정확도 개선 (100ms 정밀도)

**문제:**
- 모바일 백그라운드에서 3초 오차 발생
- `setInterval`이 throttle됨

**해결:**
- 절대 시간 기준 계산 (`targetEndTimeRef`)
- Page Visibility API 추가 (탭 활성화 시 즉시 재동기화)
- 100ms마다 체크 (초 단위 변경 시만 렌더링)

**수정 파일:**
- `components/dashboard/FocusTimer.tsx:39-41, 85-92, 136-193, 241-299`

**커밋:** `b025510`

---

### 6. 아카이브된 작업 제외 (대시보드/칸반/목표)

**문제:**
- 칸반에서 아카이브한 작업이 대시보드 밀린 작업에 계속 표시됨

**해결:**
- 모든 작업 조회 API에 아카이브 제외 필터 추가
- `status: { notIn: ['archived_success', 'archived_failed'] }`

**수정 파일:**
- `app/api/tasks/route.ts:35`
- `app/api/tasks/today/route.ts:56`
- `app/api/goals/route.ts:36`

**커밋:** `ad10618`

---

## 📊 작업 통계

- **수정 파일**: 12개
- **신규 파일**: 2개
- **커밋**: 5개 (1개 푸시 대기)
- **해결한 버그**: 6개
- **신규 기능**: 2개 (Task weight, 하이브리드 알림)
- **소요 시간**: ~6시간

---

## 📁 파일 변경 내역

### 신규 생성
1. `lib/notificationSound.ts` - Web Audio API 벨 소리
2. `.github/workflows/cron-jobs.yml` - GitHub Actions 크론잡

### 수정
1. `prisma/schema.prisma` - Task.weight 필드
2. `app/api/goals/route.ts` - weight 기반 진행률
3. `app/api/tasks/route.ts` - 아카이브 제외
4. `app/api/tasks/today/route.ts` - 아카이브 제외
5. `components/dashboard/TaskModal.tsx` - weight 입력 UI
6. `components/dashboard/FocusTimer.tsx` - 100ms 정밀도
7. `app/dashboard/page.tsx` - 모바일 헤더
8. `lib/notifications.ts` - 하이브리드 알림
9. `lib/notificationSound.ts` - iOS Safari resume
10. `app/layout.tsx` - Sonner Toaster
11. `app/settings/page.tsx` - 테스트 알림
12. `app/globals.css` - Sonner 스타일

---

## 🧪 테스트 가이드

### 1. Task Weight 기능
```
1. 목표 "나무 100개 베기" 생성
2. 작업 "나무 10개 베기" 생성
   - 목표: "나무 100개 베기" 선택
   - 목표 기여도: 10
3. 작업 완료 → 진행률 10% 확인
4. 작업 "나무 20개 베기" 생성
   - 목표 기여도: 20
5. 작업 완료 → 진행률 30% 확인 (10+20 / 100)
```

### 2. 하이브리드 알림
```
Mac Chrome:
1. 설정 > 테스트 알림
2. 확인: 소리 + 토스트

iOS Safari:
1. 설정 > 테스트 알림
2. 확인: 소리 + 토스트 (시스템 알림 없음 - 정상)

백그라운드:
1. 포커스 타이머 1분 시작
2. 다른 탭으로 이동
3. 1분 후 Mac 알림 센터 확인
```

### 3. 포커스 타이머 정확도
```
모바일:
1. 타이머 시작
2. 백그라운드 전환 (10초)
3. 앱으로 돌아오기
4. 정확히 10초 지났는지 확인
```

### 4. 아카이브 제외
```
1. 작업 완료
2. 칸반에서 "성공 아카이브"
3. 대시보드로 이동
4. 밀린 작업에 표시 안 됨 확인
```

---

## 🔗 관련 커밋

- `a991678` - feat: Task weight 필드 및 GitHub Actions 크론 추가 (푸시 대기)
- `bf74068` - fix: 모바일 UI 및 iOS Safari 알림 개선
- `aad7719` - feat: 하이브리드 알림 시스템 구현
- `b025510` - fix: 포커스 타이머 모바일 정확도 개선
- `0e1aff3` - fix: 알림 아이콘 404 에러 제거
- `ad10618` - fix: 포커스 타이머 및 목표 진행률 버그 수정

---

## 📌 다음 작업

1. **최우선**: GitHub Actions 워크플로우 푸시
2. GitHub Secrets 설정 (`CRON_SECRET`)
3. 워크플로우 수동 실행 테스트
4. 자정 자동 실행 확인 (다음날)
5. Vercel DB 푸시 (Task.weight 필드 마이그레이션)

---

**작업 일자**: 2026-01-12
**담당**: Claude Code + Partner
